<!doctype html>
<html lang="en">
<head>
  <title>Premium Shop</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="./shop-style.css">
  
</head>
<body>
  <div class="container">
    <header class="topnav">
      <div class="topnav--subsection">
        
        <!-- / .menu -->
        
        <nav class="branding">
          <a href="#">eshop</a>
        </nav>
        <!-- / .branding -->
        
        <nav class="user-engagement">
          <a href="#">Profile</a>
          <a href="#">Cart</a>
          <a href="#">Contact us</a>
        </nav>
        <!-- / .user-engagement -->
        <a class="icon" href="#"></a>
      </div>
      
    </header>
    <!-- / .topnav -->
    
    <section class="banner">
      <div class="slide">
        <div class="description">
          <h1>Premium Textures</h1>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Atque deleniti similique fugit expedita commodi, consectetur, eligendi.</p>
        </div>
        <img src="https://user-images.githubusercontent.com/52452/42075807-a4f568fc-7b40-11e8-8024-d4183c805a69.png" width="350" height="350">
      </div>
    </section>
    <!-- / .banner -->
    
    <section id="item-list" class="shop-items"></section>

    <section id="bottom-buttons">
      <button onclick="renderList()">Update List</button>
      <button onclick="uploadFile()">Upload File</button>
    </section>
    
    <footer class="main-footer">
      <nav>
        <h3>Customer Service</h3>
        <ul>
          <li><a href="#">Help & Contact Us</a></li>
          <li><a href="#">Returns & Refunds</a></li>
          <li><a href="#">Online Stores</a></li>
          <li><a href="#">Terms & Conditions</a></li>
        </ul>
      </nav>
      <nav>
        <h3>Customer Service</h3>
        <ul>
          <li><a href="#">Help & Contact Us</a></li>
          <li><a href="#">Returns & Refunds</a></li>
          <li><a href="#">Online Stores</a></li>
          <li><a href="#">Terms & Conditions</a></li>
        </ul>
      </nav>
      <nav>
        <h3>Customer Service</h3>
        <ul>
          <li><a href="#">Help & Contact Us</a></li>
          <li><a href="#">Returns & Refunds</a></li>
          <li><a href="#">Online Stores</a></li>
          <li><a href="#">Terms & Conditions</a></li>
        </ul>
      </nav>
      <nav>
        <h3>Customer Service</h3>
        <ul>
          <li><a href="#">Help & Contact Us</a></li>
          <li><a href="#">Returns & Refunds</a></li>
          <li><a href="#">Online Stores</a></li>
          <li><a href="#">Terms & Conditions</a></li>
        </ul>
      </nav>
    </footer>
    
  </div>
  <!-- / .container -->
  <!-- partial -->
  
  <!-- <div class="container">
    <main class="col-md-8">
      <h2>Test List:</h2>
      <ul id="itemList"></ul>
      <button onclick="renderList()">Update List</button>
      <button onclick="uploadFile()">Upload File</button>
    </main>
  </div> -->
  
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  
  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-storage.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-database.js"></script>
  
  <script>
    function renderList() {
      console.log("Render called!");
      // Find all the prefixes and items.
      listRef.listAll().then(function(res) {
        res.prefixes.forEach(function(folderRef) {
          // All the prefixes under listRef.
          // You may call listAll() recursively on them.
        });
        res.items.forEach(function(itemRef) {
          var outputList = document.getElementById("item-list");
          if (outputList.innerHTML != "") {
            outputList.innerHTML = "";
          }
          itemRef.getDownloadURL().then(function(url) {
            itemRef.getMetadata().then(function(metadata) {
              if (metadata.contentType.includes("image")) {
                outputList.innerHTML = outputList.innerHTML + 
                `<div class="shop-item">
                  <a href="#" class="shop-item--container">
                    <div class="meta">
                      <span class="tag">new</span>
                      <span class="discount">FLAT MAPS - 2X2 METERS</span>
                    </div>
                    <img src="${url}" width="160" height="160">
                  </a>
                  <div class="title">
                    <h3><a href="${url}" target="_blank">${itemRef.name.substring(0, itemRef.name.lastIndexOf('.'))}</a></h3>
                  </div>
                  <div class="price">
                    <a class="dowloadLink" href="" download="${url}"> Download File </a>
                    <button onclick="deleteFile('${itemRef.name}')">Delete File</button>
                  </div>
                </div>`;
              } else {
                outputList.innerHTML = outputList.innerHTML + 
                `<div class="shop-item">
                  <a href="#" class="shop-item--container">
                    <div class="meta">
                      <span class="tag">new</span>
                      <span class="discount">ROYALTY-FREE FILES</span>
                    </div>
                    <img src="https://icons.iconarchive.com/icons/custom-icon-design/mono-general-2/512/document-icon.png" width="160" height="160">
                  </a>
                  <div class="title">
                    <h3><a href="${url}" target="_blank">${itemRef.name.substring(0, itemRef.name.lastIndexOf('.'))}</a></h3>
                  </div>
                  <div class="price">
                    <a class="dowloadLink" href="" download="${url}"> Download File </a>
                    <button onclick="deleteFile('${itemRef.name}')">Delete File</button>
                  </div>
                </div>`;
              }
            }).catch(function(error) {
              console.log(error);
            });
          }).catch(function(error) {
            console.log(error);
          })
        });
      }).catch(function(error) {
        console.log(error);
      });
    }
    
    function uploadFile() {
      var input = document.createElement('input');
      input.type = 'file';
      
      //Upload function
      input.onchange = e => { 
        var file = e.target.files[0]; 
        
        // Create the file metadata
        var metadata = {
          contentType: file.type
        };
        
        // Upload file and metadata to the object 'images/mountains.jpg'
        var uploadTask = listRef.child(file.name).put(file, metadata);
        
        // Listen for state changes, errors, and completion of the upload.
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
        function(snapshot) {
          // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
          var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log('Upload is ' + progress + '% done');
          switch (snapshot.state) {
            case firebase.storage.TaskState.PAUSED: // or 'paused'
            console.log('Upload is paused');
            break;
            case firebase.storage.TaskState.RUNNING: // or 'running'
            console.log('Upload is running');
            break;
          }
        }, function(error) {
          console.log(error);
        }, function() {
          renderList();
        });
        
      }
      
      //Trigger upload function upon clicking the button
      input.click();
    }
    
    function deleteFile(name) {
      // Create a reference to the file to delete
      var deleteRef = listRef.child(name);
      
      // Delete the file
      if (confirm("Are you sure you want to delete it?")) {
        deleteRef.delete().then(function() {
        renderList();
        var outputList = document.getElementById("itemList");
        console.log(`Successfully deleted file: ${name}</li>`);
      }).catch(function(error) {
        console.log(error);
      });
      }
    }
    
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyDhttbsgfX6dBU_HbmxrTV_qLU6ttCKkL4",
      authDomain: "alex-singulars-2020-test.firebaseapp.com",
      projectId: "alex-singulars-2020-test",
      storageBucket: "alex-singulars-2020-test.appspot.com",
      messagingSenderId: "603380152330",
      appId: "1:603380152330:web:d47ea6ed275a56b88c87f3"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Points to the root reference
    var storageRef = firebase.storage().ref();
    
    // Create a reference under which you want to list
    var listRef = storageRef.child('E-SHOP Files');
    
    //Render the list for the first time
    renderList();
    
  </script>
</body>
</html>